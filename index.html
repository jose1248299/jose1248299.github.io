<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supervisor de Cámaras</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#111;--card:#18181b;--muted:#a1a1aa;--ok:#0EA5E9;--bad:#ef4444;--border:#27272a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#fff}

    /* Barra superior con botón */
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:16px 16px 8px;gap:12px}
    h1{margin:0;font-weight:700}
    .actions{display:flex;gap:8px;align-items:center}

    .subtitle{margin:0 16px 16px;color:var(--muted);font-size:14px}
    .grid{display:grid;gap:16px;padding:0 16px 24px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card-header{display:flex;justify-content:space-between;align-items:center;padding:16px 16px 0}
    .title{font-size:20px;margin:0}
    .kpi{font-size:14px;color:var(--muted)}
    .kpi strong{color:#fff}
    .badge{display:inline-flex;align-items:center;justify-content:center;min-width:48px;height:28px;border-radius:999px;border:1px solid var(--border);font-weight:600}
    .badge.ok{color:#fff;background:linear-gradient(to right,var(--ok),#22c55e)}
    .badge.bad{color:#fff;background:linear-gradient(to right,var(--bad),#f59e0b)}
    .chart-wrap{position:relative;height:160px;padding:8px 16px 0}
    .sections{display:grid;gap:8px;padding:8px 16px 16px}
    details{background:#131316;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    summary{list-style:none;cursor:pointer;padding:12px 14px;display:flex;gap:10px;align-items:center}
    summary::-webkit-details-marker{display:none}
    .pill{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;color:var(--muted)}
    .state.off{color:#fff;background:var(--bad);}
    .state.on{color:#111;background:#22c55e;}
    .state{font-size:12px;border-radius:6px;padding:2px 6px;font-weight:700}
    .list{padding:8px 12px 12px;display:grid;gap:8px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid var(--border);border-radius:10px;cursor:pointer}
    .name{font-weight:600}
    .muted{color:var(--muted);font-size:12px}
    .error{margin:0 16px 16px;padding:12px;border:1px solid #7f1d1d;background:#451a1a;border-radius:12px}
    .link{cursor:pointer;text-decoration:underline;text-underline-offset:2px}
    .hidden{display:none}

    /* Vista de detalle */
    .detail{padding:16px}
    .detail h2{margin:0 0 8px}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#141414;color:#fff;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin:12px 0}

    /* Cards dentro del detalle con layout responsivo */
    .detail-grid{
      display:grid;
      gap:16px;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      margin-top:12px;
    }
    .card-header-sm{padding:16px 16px 0}
    .card-header-sm .title{font-size:18px}
    .card-body{padding:8px 16px 16px}

    /* Botón volver separado del grid */
    .detail-actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .loading{color:var(--muted);font-size:14px;margin:8px 0 0 0}
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Supervisor de Cámaras</h1>
    <div class="actions">
      <button id="refreshBtn" class="btn" aria-live="polite" title="Actualizar ahora">↻ Actualizar</button>
    </div>
  </div>

  <p class="subtitle" id="subtitle" aria-live="polite">Cargando datos de cámaras…</p>

  <div class="grid" id="countries"></div>

  <!-- Vista de detalle -->
  <section id="detailView" class="detail hidden" aria-live="polite"></section>

  <p id="errorBox" class="error" style="display:none"></p>

  <script>
    // === Endpoints ===
    const listApiUrl = 'https://cams.misolas.com/v1/cameras/';
    const detailApiBase = 'https://api3.misolas.com/devices/'; // devices/{id}/

    // Países visibles en tablero
    const countries = [
      { id: '1', name: 'Perú' },
      { id: '2', name: 'Chile' }
    ];

    const charts = new Map(); // countryId -> Chart instance
    let currentData = [];
    const camIndex = new Map();

    const byStatus = (arr) => ({
      online: arr.filter(c => (c.status||'').toLowerCase() === 'online'),
      offline: arr.filter(c => (c.status||'').toLowerCase() !== 'online'),
    });

    function fmtPercent(n){ return new Intl.NumberFormat('es-PE',{maximumFractionDigits:0}).format(n); }

    function el(tag, attrs={}, ...children){
      const node=document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(v==null)return;
        if(k==='class')node.className=v;
        else if(k==='text')node.textContent=v;
        else if(k.startsWith('on')) node.addEventListener(k.slice(2).toLowerCase(),v);
        else node.setAttribute(k,v);
      });
      children.flat().forEach(ch=>{
        if(ch==null)return;
        if(typeof ch==='string')node.appendChild(document.createTextNode(ch));
        else node.appendChild(ch);
      });
      return node;
    }

    function sectionCard(title, ...children){
      const wrap = el('div',{class:'card section-card'});
      const header = el('div',{class:'card-header-sm'}, el('h3',{class:'title',text:title}));
      const body = el('div',{class:'card-body'});
      children.flat().forEach(ch => body.appendChild(ch));
      wrap.appendChild(header);
      wrap.appendChild(body);
      return wrap;
    }

    function renderCountryCard(country,cams){
      const wrap=el('div',{class:'card',id:`country-${country.id}`});
      const {online,offline}=byStatus(cams);
      const total=cams.length;
      const health=total?Math.round((online.length/total)*100):0;
      const header=el('div',{class:'card-header'},
        el('div',{},
          el('h2',{class:'title',text:country.name}),
          el('div',{class:'kpi','aria-live':'polite'},
            el('span',{text:'Offline: '}),
            el('strong',{text:offline.length}),
            el('span',{text:` / Total: ${total}`})
          )
        ),
        el('span',{class:`badge ${health>=90?'ok':'bad'}`,title:'Salud (online / total)'},`${fmtPercent(health)}%`)
      );
      const chartWrap=el('div',{class:'chart-wrap'},el('canvas',{id:`chart-${country.id}`}));
      const sections=el('div',{class:'sections'},
        buildAccordion('Cámaras offline',offline,'off'),
        buildAccordion('Cámaras online',online,'on')
      );
      wrap.appendChild(header);
      wrap.appendChild(chartWrap);
      wrap.appendChild(sections);
      return wrap;
    }

    function buildAccordion(title,list,mode){
      const countPill=el('span',{class:'pill'},`${list.length}`);
      const statePill=el('span',{class:`state ${mode}`},mode==='on'?'ONLINE':'OFFLINE');
      const summary=el('summary',{},statePill,el('strong',{style:'flex:1'},` ${title}`),countPill);
      const container=el('details');
      container.appendChild(summary);
      const items=list
        .sort((a,b)=>(a.name||'').localeCompare(b.name||'','es'))
        .map(cam=>{
          const id=getCamId(cam);
          return el('div',{class:'item',onClick:()=>goToCamera(id)},
            el('div',{},
              el('div',{class:'name',text:cam.name||'Cámara'}),
              el('div',{class:'muted'},(cam.status||'').toUpperCase())
            ),
            el('div',{class:'muted'}, cam.site || cam.location || cam.ciudad || '')
          );
        });
      const listWrap=el('div',{class:'list'},items);
      container.appendChild(listWrap);
      return container;
    }

    // upsertChart robusto
    function upsertChart(countryId,online,offline){
      const id = `chart-${countryId}`;
      const canvas = document.getElementById(id);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const existing = charts.get(countryId);

      if (existing && existing.canvas && existing.canvas !== canvas) {
        try { existing.destroy(); } catch(_) {}
        charts.delete(countryId);
      }

      const data = {
        labels: ['Online','Offline'],
        datasets: [{ data:[online,offline], backgroundColor:['#0EA5E9','#ef4444'] }]
      };
      const opts = {
        plugins:{ legend:{display:false}, title:{display:true,text:'Salud de red',color:'#fff',font:{size:14}} },
        responsive:true, maintainAspectRatio:false, cutout:'60%', animation:false
      };

      if (charts.has(countryId)) {
        const chart = charts.get(countryId);
        chart.data = data;
        chart.update();
      } else {
        const chart = new Chart(ctx, { type:'doughnut', data, options:opts });
        chart.canvas = canvas;
        charts.set(countryId, chart);
      }
    }

    // Prioriza idcamara del listado
    function getCamId(cam){
      return String(
        cam.idcamara ?? cam.id ?? cam.uid ?? cam.uuid ?? cam.codigo ?? cam.code ?? cam.name
      );
    }

    function indexCameras(arr){ camIndex.clear(); for(const c of arr){ camIndex.set(getCamId(c),c);} }
    function goToCamera(id){ location.hash=`#/camera/${encodeURIComponent(id)}`; }
    function showList(){ document.getElementById('countries').classList.remove('hidden'); document.getElementById('detailView').classList.add('hidden'); }

    // ========= RESOLVER ID NUMÉRICO PARA DETALLE =========
    function resolveDeviceId(cam){
      // El listado trae "idcamara": "55" -> endpoint /devices/55/
      if (cam && cam.idcamara != null) {
        const n = Number(String(cam.idcamara).trim());
        if (Number.isFinite(n)) return n;
      }
      // fallback por si algún caso trae otro campo con dígitos
      const candidates = [cam?.id, cam?.code, cam?.codigo, cam?.uid, cam?.uuid, cam?.name].filter(v => v != null);
      for (const val of candidates){
        const m = String(val).match(/^\d+$/) || String(val).match(/\d+/);
        if (m){
          const num = Number(m[0]);
          if (Number.isFinite(num)) return num;
        }
      }
      return null;
    }

    // ============ Detalle dinámico ============
    async function fetchCameraDetail(cam){
      const numId = resolveDeviceId(cam);
      if (!Number.isFinite(numId)) {
        throw new Error('No se pudo resolver un ID numérico para esta cámara');
      }
      const url = `${detailApiBase}${encodeURIComponent(numId)}/`;
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 10000);
      try{
        const res = await fetch(url, { signal: ctrl.signal, cache: 'no-store' });
        clearTimeout(t);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally {
        clearTimeout(t);
      }
    }

    function sectionCardContent(cam, rec){
      const r = (k, fallback='—') => (rec && rec[k]!=null && String(rec[k]).trim()!=='' ? String(rec[k]) : fallback);

      // Stream: primero RTMP del detalle; si no hay, usa HLS del listado
      const hls = Array.isArray(cam.streams) ? cam.streams.find(s => s.format === 'hls') : null;
      const streamPrimary = r('rtmp', '') || (hls?.url || '—');

      const ipCam = r('ip_cam', null);
      const ipRed = r('ip_red', null);
      const panelUrl = ipCam ? `http://${ipCam}` : (ipRed ? `http://${ipRed}` : '#');

      const latStr = r('latitud');
      const lonStr = r('longitud');
      const latNum = Number(latStr);
      const lonNum = Number(lonStr);
      const hasCoords = Number.isFinite(latNum) && Number.isFinite(lonNum);

      const meta=el('div',{class:'kv'},
        el('div',{class:'muted',text:'Estado'}),el('div',{text:(cam.status||'').toUpperCase()}),
        el('div',{class:'muted',text:'Ubicación'}),el('div',{text: cam.site || cam.location || cam.ciudad || r('ubicacion','—')}),
        el('div',{class:'muted',text:'País'}),el('div',{text:String(cam.pais??cam.country??'—')}),
        el('div',{class:'muted',text:'ID'}),el('div',{text:getCamId(cam)})
      );

      const tecnicos=el('div',{class:'kv'},
        el('div',{class:'muted',text:'IP Cámara'}),el('div',{text:r('ip_cam')}),
        el('div',{class:'muted',text:'Modelo'}),el('div',{text:r('modelo')}),
        el('div',{class:'muted',text:'Marca'}),el('div',{text:r('marca')}),
        el('div',{class:'muted',text:'N° Serie'}),el('div',{text:r('numero_serie')}),
        el('div',{class:'muted',text:'Instalación'}),el('div',{text:r('instalacion')}),
        el('div',{class:'muted',text:'Energía'}),el('div',{text:r('energia')})
      );

      const red=el('div',{class:'kv'},
        el('div',{class:'muted',text:'Operador'}),el('div',{text:r('operador')}),
        el('div',{class:'muted',text:'Titular línea'}),el('div',{text:r('titular_linea')}),
        el('div',{class:'muted',text:'Línea'}),el('div',{text:r('linea')}),
        el('div',{class:'muted',text:'Red (SSID)'}),el('div',{text:r('red')}),
        el('div',{class:'muted',text:'IP Red'}),el('div',{text:r('ip_red')}),
        el('div',{class:'muted',text:'Usuario módem'}),el('div',{text:r('usuario_modem')}),
        el('div',{class:'muted',text:'Clave módem'}),el('div',{text:r('clave_modem')}),
        el('div',{class:'muted',text:'Clave WiFi'}),el('div',{text:r('clave_wifi')})
      );

      const enlaces=el('div',{class:'kv'},
        el('div',{class:'muted',text:'Stream (RTSP/RTMP/HLS)'}),
        el('div',{},
          streamPrimary && streamPrimary !== '—'
            ? el('a',{href:streamPrimary,target:'_blank',rel:'noopener',class:'link'},streamPrimary)
            : el('span',{text:'—'})
        ),
        el('div',{class:'muted',text:'Panel'}),
        el('div',{},
          panelUrl && panelUrl !== '#'
            ? el('a',{href:panelUrl,target:'_blank',rel:'noopener',class:'link'},panelUrl)
            : el('span',{text:'—'})
        )
      );

      const ubicacion=el('div',{class:'kv'},
        el('div',{class:'muted',text:'Latitud'}),el('div',{text:latStr}),
        el('div',{class:'muted',text:'Longitud'}),el('div',{text:lonStr}),
        el('div',{class:'muted',text:'Ver en mapa'}),
        el('div',{},
          hasCoords
            ? el('button',{
                class:'btn',
                onClick:()=>{
                  const url = `https://www.google.com/maps?q=${encodeURIComponent(latNum)},${encodeURIComponent(lonNum)}`;
                  window.open(url,'_blank','noopener');
                }
              },'🌍 Abrir en Google Maps')
            : el('span',{text:'No disponible'})
        )
      );

      const contacto=el('div',{class:'kv'},
        el('div',{class:'muted',text:'Host'}),el('div',{text:r('host')}),
        el('div',{class:'muted',text:'Contacto Host'}),el('div',{text:r('contacto_host')}),
        el('div',{class:'muted',text:'Técnico'}),el('div',{text:r('tecnico')}),
        el('div',{class:'muted',text:'Contacto Técnico'}),el('div',{text:r('contacto_tecnico')})
      );

      return { meta, tecnicos, red, enlaces, ubicacion, contacto };
    }

    function renderDetail(cam, rec){
      const r = (k, fallback='—') => (rec && rec[k]!=null && String(rec[k]).trim()!=='' ? String(rec[k]) : fallback);

      const detail=document.getElementById('detailView');
      document.getElementById('countries').classList.add('hidden');
      detail.classList.remove('hidden');
      detail.innerHTML='';

      const actions = el('div',{class:'detail-actions'},
        el('button',{class:'btn',onClick:()=>{location.hash='#/';}},'← Volver'),
        el('h2',{text: cam.name || r('nombre','Cámara')})
      );

      const { meta, tecnicos, red, enlaces, ubicacion, contacto } = sectionCardContent(cam, rec);

      const grid = el('div',{class:'detail-grid'});
      grid.appendChild(sectionCard('Resumen', meta));
      grid.appendChild(sectionCard('Información técnica', tecnicos));
      grid.appendChild(sectionCard('Red y conectividad', red));
      grid.appendChild(sectionCard('Enlaces', enlaces));
      grid.appendChild(sectionCard('Ubicación', ubicacion));
      grid.appendChild(sectionCard('Contacto', contacto));

      detail.appendChild(actions);
      detail.appendChild(grid);
    }

    async function showDetail(cam){
      const detail=document.getElementById('detailView');
      document.getElementById('countries').classList.add('hidden');
      detail.classList.remove('hidden');
      detail.innerHTML='';

      const header = el('div',{class:'detail-actions'},
        el('button',{class:'btn',onClick:()=>{location.hash='#/';}},'← Volver'),
        el('h2',{text:cam.name || 'Cámara'})
      );
      const loading = el('p',{class:'loading',text:'Cargando detalles de la cámara…'});
      detail.appendChild(header);
      detail.appendChild(loading);

      try{
        const rec = await fetchCameraDetail(cam);
        renderDetail(cam, rec);
      }catch(err){
        console.error('Error cargando detalle:', err);

        // Fallback con datos del listado y aviso
        const grid = el('div',{class:'detail-grid'});

        // Resumen mínimo
        const meta=el('div',{class:'kv'},
          el('div',{class:'muted',text:'Estado'}),el('div',{text:(cam.status||'').toUpperCase()}),
          el('div',{class:'muted',text:'Ubicación'}),el('div',{text: cam.site || cam.location || cam.ciudad || '—'}),
          el('div',{class:'muted',text:'País'}),el('div',{text:String(cam.pais??cam.country??'—')}),
          el('div',{class:'muted',text:'ID'}),el('div',{text:getCamId(cam)})
        );

        // Ubicación desde el listado (si está)
        const latStr = cam.latitud, lonStr = cam.longitud;
        const latNum = Number(latStr), lonNum = Number(lonStr);
        const hasCoords = Number.isFinite(latNum) && Number.isFinite(lonNum);
        const ubicFallback = el('div',{class:'kv'},
          el('div',{class:'muted',text:'Latitud'}), el('div',{text: latStr ?? '—'}),
          el('div',{class:'muted',text:'Longitud'}), el('div',{text: lonStr ?? '—'}),
          el('div',{class:'muted',text:'Ver en mapa'}),
          el('div',{}, hasCoords
            ? el('button',{
                class:'btn',
                onClick:()=>window.open(`https://www.google.com/maps?q=${encodeURIComponent(latNum)},${encodeURIComponent(lonNum)}`,'_blank','noopener')
              },'🌍 Abrir en Google Maps')
            : el('span',{text:'No disponible'})
          )
        );

        const warn = el('p',{class:'error',text:'No se pudo cargar el detalle de la cámara. Se muestran datos básicos del listado.'});

        grid.appendChild(sectionCard('Resumen', meta));
        grid.appendChild(sectionCard('Ubicación', ubicFallback));
        grid.appendChild(sectionCard('Aviso', warn));
        detail.appendChild(grid);
      }
    }

    function router(){
      const h=location.hash||'#/';
      const m=h.match(/^#\/camera\/([^#?]+)/);
      if(m){ const id=decodeURIComponent(m[1]); const cam=camIndex.get(id); if(cam){showDetail(cam);} else {showList();} }
      else{showList();}
    }

    window.addEventListener('hashchange',router);

    // ============ Carga y render principal ============
    async function load(manual=false){
      const subtitle=document.getElementById('subtitle');
      const container=document.getElementById('countries');
      const errorBox=document.getElementById('errorBox');
      const refreshBtn=document.getElementById('refreshBtn');

      errorBox.style.display='none';
      const prevText = subtitle.textContent;
      if(manual){ subtitle.textContent='Actualizando…'; }
      if(refreshBtn){ refreshBtn.disabled = true; refreshBtn.textContent = 'Actualizando…'; }

      try{
        const ctrl=new AbortController();
        const t=setTimeout(()=>ctrl.abort(),10000);
        const res=await fetch(listApiUrl,{signal:ctrl.signal});
        clearTimeout(t);
        if(!res.ok)throw new Error(`HTTP ${res.status}`);
        const data=await res.json();

        currentData=Array.isArray(data)?data:[];
        indexCameras(currentData);
        subtitle.textContent=`Actualizado: ${new Date().toLocaleString('es-PE')}`;

        const byCountry=new Map(countries.map(c=>[c.id,[]]));
        for(const cam of currentData){
          const pid=String(cam.pais??cam.country_id??cam.country??'');
          if(byCountry.has(pid))byCountry.get(pid).push(cam);
        }

        // Destruir charts antes de rehacer DOM
        charts.forEach(ch => { try { ch.destroy(); } catch(_){} });
        charts.clear();

        // Re-render
        container.innerHTML='';
        countries.forEach(country=>{
          const cams=byCountry.get(country.id)||[];
          const card=renderCountryCard(country,cams);
          container.appendChild(card);
          const {online,offline}=byStatus(cams);
          upsertChart(country.id,online.length,offline.length);
        });

        router();
      }catch(err){
        console.error('Error cargando las cámaras:',err);
        errorBox.textContent='No se pudo cargar la información. Intenta nuevamente.';
        errorBox.style.display='block';
        if(manual){ subtitle.textContent = prevText; }
      }finally{
        if(refreshBtn){ refreshBtn.disabled = false; refreshBtn.textContent = '↻ Actualizar'; }
      }
    }

    // Carga inicial
    load();

    // Botón para actualizar bajo demanda
    document.getElementById('refreshBtn').addEventListener('click', ()=> load(true));
  </script>
</body>
</html>
