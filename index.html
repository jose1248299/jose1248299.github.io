<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supervisor de Cámaras</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#111;--card:#18181b;--muted:#a1a1aa;--ok:#0EA5E9;--bad:#ef4444;--border:#27272a;
      --skel-base:#1c1c20; --skel-highlight:#242428; --accent:#0EA5E9;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#fff}

    /* Barra superior con botón */
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:16px 16px 8px;gap:12px}
    h1{margin:0;font-weight:700}
    .actions{display:flex;gap:8px;align-items:center}

    .subtitle{margin:0 16px 16px;color:var(--muted);font-size:14px}
    .grid{display:grid;gap:16px;padding:0 16px 24px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
    .card{position:relative;background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .card-header{display:flex;justify-content:space-between;align-items:center;padding:16px 16px 0}
    .title{font-size:20px;margin:0}
    .kpi{font-size:14px;color:var(--muted)}
    .kpi strong{color:#fff}
    .badge{display:inline-flex;align-items:center;justify-content:center;min-width:48px;height:28px;border-radius:999px;border:1px solid var(--border);font-weight:600}
    .badge.ok{color:#fff;background:linear-gradient(to right,var(--ok),#22c55e)}
    .badge.bad{color:#fff;background:linear-gradient(to right,var(--bad),#f59e0b)}
    .chart-wrap{position:relative;height:160px;padding:8px 16px 0}
    .sections{display:grid;gap:8px;padding:8px 16px 16px}
    details{background:#131316;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    summary{list-style:none;cursor:pointer;padding:12px 14px;display:flex;gap:10px;align-items:center}
    summary::-webkit-details-marker{display:none}
    .pill{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;color:var(--muted)}
    .state.off{color:#fff;background:var(--bad);}
    .state.on{color:#111;background:#22c55e;}
    .state{font-size:12px;border-radius:6px;padding:2px 6px;font-weight:700}
    .list{padding:8px 12px 12px;display:grid;gap:8px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid var(--border);border-radius:10px;cursor:pointer}
    .name{font-weight:600}
    .muted{color:var(--muted);font-size:12px}
    .error{margin:0 16px 16px;padding:12px;border:1px solid #7f1d1d;background:#451a1a;border-radius:12px}
    .link{cursor:pointer;text-decoration:underline;text-underline-offset:2px}
    .hidden{display:none}

    /* Vista de detalle */
    .detail{padding:16px}
    .detail h2{margin:0 0 8px}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#141414;color:#fff;cursor:pointer}
    .btn.primary{border-color:transparent;background:var(--accent);color:#001018}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin:12px 0}
    .kv .field{display:flex;flex-direction:column;gap:4px}
    .kv label{font-size:12px;color:var(--muted)}
    .input, .textarea{
      width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#111;color:#fff;
    }
    .textarea{min-height:80px;resize:vertical}

    /* Cards detalle con layout responsivo */
    .detail-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));margin-top:12px}
    .card-header-sm{padding:16px 16px 0}
    .card-header-sm .title{font-size:18px}
    .card-body{padding:8px 16px 16px}

    /* Acciones detalle */
    .detail-actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .loading{color:var(--muted);font-size:14px;margin:8px 0 0 0}

    /* Skeleton */
    @keyframes shimmer { 0% {background-position: -200% 0;} 100% {background-position: 200% 0;} }
    .skeleton{display:block;position:relative;overflow:hidden;background:linear-gradient(90deg,var(--skel-base),var(--skel-highlight),var(--skel-base));background-size:200% 100%;animation:shimmer 1.2s infinite linear;border-radius:8px}
    .skel-line{height:12px;margin:8px 0}
    .skel-line.lg{height:18px}
    .skel-line.xs{height:8px}
    .kv.skeleton-kv{grid-template-columns:140px 1fr}
    .skel-pill{height:28px;width:90px;border-radius:999px}

    /* Edit button (pencil) */
    .card-edit{
      position:absolute; right:12px; bottom:12px;
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px; border:1px solid var(--border); border-radius:999px; background:#131316; color:#fff; cursor:pointer;
      font-size:12px;
    }
    .card-edit:hover{border-color:#3a3a3f}
    .card-actions{display:flex;gap:8px;margin-top:8px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Supervisor de Cámaras</h1>
    <div class="actions">
      <button id="refreshBtn" class="btn" aria-live="polite" title="Actualizar ahora">↻ Actualizar</button>
    </div>
  </div>

  <p class="subtitle" id="subtitle" aria-live="polite">Cargando datos de cámaras…</p>

  <div class="grid" id="countries"></div>

  <!-- Vista de detalle -->
  <section id="detailView" class="detail hidden" aria-live="polite"></section>

  <p id="errorBox" class="error" style="display:none"></p>

  <script>
    // === Endpoints ===
    const listApiUrl = 'https://cams.misolas.com/v1/cameras/';
    const detailApiBase = 'https://api3.misolas.com/devices/'; // devices/{id}/
    const updateSuffix = '/update/';

    // Países visibles en tablero
    const countries = [
      { id: '1', name: 'Perú' },
      { id: '2', name: 'Chile' }
    ];

    const charts = new Map(); // countryId -> Chart instance
    let currentData = [];
    const camIndex = new Map();

    // guardo el último detalle para el cam actual, para comparar cambios
    let currentDetailRecord = null;

    const byStatus = (arr) => ({
      online: arr.filter(c => (c.status||'').toLowerCase() === 'online'),
      offline: arr.filter(c => (c.status||'').toLowerCase() !== 'online'),
    });

    function fmtPercent(n){ return new Intl.NumberFormat('es-PE',{maximumFractionDigits:0}).format(n); }

    function el(tag, attrs={}, ...children){
      const node=document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(v==null)return;
        if(k==='class')node.className=v;
        else if(k==='text')node.textContent=v;
        else if(k.startsWith('on')) node.addEventListener(k.slice(2).toLowerCase(),v);
        else node.setAttribute(k,v);
      });
      children.flat().forEach(ch=>{
        if(ch==null)return;
        if(typeof ch==='string')node.appendChild(document.createTextNode(ch));
        else node.appendChild(ch);
      });
      return node;
    }

    function sectionCard(title, key, bodyContent, editable=true){
      const wrap = el('div',{class:'card section-card', 'data-section':key});
      const header = el('div',{class:'card-header-sm'}, el('h3',{class:'title',text:title}));
      const body = el('div',{class:'card-body'});
      (Array.isArray(bodyContent)?bodyContent:[bodyContent]).forEach(ch => body.appendChild(ch));
      wrap.appendChild(header);
      wrap.appendChild(body);
      if (editable){
        const editBtn = el('button',{class:'card-edit', onClick:()=>enterEditSection(key)},'✏️ Editar');
        wrap.appendChild(editBtn);
      }
      return wrap;
    }

    function renderCountryCard(country,cams){
      const wrap=el('div',{class:'card',id:`country-${country.id}`});
      const {online,offline}=byStatus(cams);
      const total=cams.length;
      const health=total?Math.round((online.length/total)*100):0;
      const header=el('div',{class:'card-header'},
        el('div',{},
          el('h2',{class:'title',text:country.name}),
          el('div',{class:'kpi','aria-live':'polite'},
            el('span',{text:'Offline: '}),
            el('strong',{text:offline.length}),
            el('span',{text:` / Total: ${total}`})
          )
        ),
        el('span',{class:`badge ${health>=90?'ok':'bad'}`,title:'Salud (online / total)'},`${fmtPercent(health)}%`)
      );
      const chartWrap=el('div',{class:'chart-wrap'},el('canvas',{id:`chart-${country.id}`}));
      const sections=el('div',{class:'sections'},
        buildAccordion('Cámaras offline',offline,'off'),
        buildAccordion('Cámaras online',online,'on')
      );
      wrap.appendChild(header);
      wrap.appendChild(chartWrap);
      wrap.appendChild(sections);
      return wrap;
    }

    function buildAccordion(title,list,mode){
      const countPill=el('span',{class:'pill'},`${list.length}`);
      const statePill=el('span',{class:`state ${mode}`},mode==='on'?'ONLINE':'OFFLINE');
      const summary=el('summary',{},statePill,el('strong',{style:'flex:1'},` ${title}`),countPill);
      const container=el('details');
      container.appendChild(summary);
      const items=list
        .sort((a,b)=>(a.name||'').localeCompare(b.name||'','es'))
        .map(cam=>{
          const id=getCamId(cam);
          return el('div',{class:'item',onClick:()=>goToCamera(id)},
            el('div',{},
              el('div',{class:'name',text:cam.name||'Cámara'}),
              el('div',{class:'muted'},(cam.status||'').toUpperCase())
            ),
            el('div',{class:'muted'}, cam.site || cam.location || cam.ciudad || '')
          );
        });
      const listWrap=el('div',{class:'list'},items);
      container.appendChild(listWrap);
      return container;
    }

    // upsertChart robusto
    function upsertChart(countryId,online,offline){
      const id = `chart-${countryId}`;
      const canvas = document.getElementById(id);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const existing = charts.get(countryId);

      if (existing && existing.canvas && existing.canvas !== canvas) {
        try { existing.destroy(); } catch(_) {}
        charts.delete(countryId);
      }

      const data = {
        labels: ['Online','Offline'],
        datasets: [{ data:[online,offline], backgroundColor:['#0EA5E9','#ef4444'] }]
      };
      const opts = {
        plugins:{ legend:{display:false}, title:{display:true,text:'Salud de red',color:'#fff',font:{size:14}} },
        responsive:true, maintainAspectRatio:false, cutout:'60%', animation:false
      };

      if (charts.has(countryId)) {
        const chart = charts.get(countryId);
        chart.data = data;
        chart.update();
      } else {
        const chart = new Chart(ctx, { type:'doughnut', data, options:opts });
        chart.canvas = canvas;
        charts.set(countryId, chart);
      }
    }

    // Prioriza idcamara del listado
    function getCamId(cam){
      return String(
        cam.idcamara ?? cam.id ?? cam.uid ?? cam.uuid ?? cam.codigo ?? cam.code ?? cam.name
      );
    }

    function indexCameras(arr){ camIndex.clear(); for(const c of arr){ camIndex.set(getCamId(c),c);} }
    function goToCamera(id){ location.hash=`#/camera/${encodeURIComponent(id)}`; }
    function showList(){ document.getElementById('countries').classList.remove('hidden'); document.getElementById('detailView').classList.add('hidden'); }

    // ========= RESOLVER ID NUMÉRICO PARA DETALLE / UPDATE =========
    function resolveDeviceId(cam){
      if (cam && cam.idcamara != null) {
        const n = Number(String(cam.idcamara).trim());
        if (Number.isFinite(n)) return n;
      }
      const candidates = [cam?.id, cam?.code, cam?.codigo, cam?.uid, cam?.uuid, cam?.name].filter(v => v != null);
      for (const val of candidates){
        const m = String(val).match(/^\d+$/) || String(val).match(/\d+/);
        if (m){
          const num = Number(m[0]);
          if (Number.isFinite(num)) return num;
        }
      }
      return null;
    }

    // ============ Skeletons para detalle ============
    function skelLine(w='100%', cls=''){ return el('div',{class:`skeleton skel-line ${cls}`, style:`width:${w}`}); }
    function skelKV(rows=4){
      const wrap = el('div',{class:'kv skeleton-kv'});
      for(let i=0;i<rows;i++){ wrap.appendChild(skelLine('90px','xs')); wrap.appendChild(skelLine('70%')); }
      return wrap;
    }
    function renderDetailSkeleton(cam){
      const detail=document.getElementById('detailView');
      detail.innerHTML='';

      const actions = el('div',{class:'detail-actions'},
        el('button',{class:'btn',onClick:()=>{location.hash='#/';}},'← Volver'),
        el('h2',{text:cam.name || 'Cámara'})
      );

      const grid = el('div',{class:'detail-grid'});
      grid.appendChild(sectionCard('Resumen','meta', skelKV(4), false));
      grid.appendChild(sectionCard('Información técnica','tecnicos', skelKV(6)));
      grid.appendChild(sectionCard('Red y conectividad','red', skelKV(8)));
      grid.appendChild(sectionCard('Enlaces','enlaces', skelKV(2)));
      grid.appendChild(sectionCard('Ubicación','ubicacion', skelKV(3)));
      grid.appendChild(sectionCard('Contacto','contacto', skelKV(4)));

      detail.appendChild(actions);
      detail.appendChild(grid);
    }

    // ============ API helpers ============
    async function apiPatch(deviceNumId, payload){
      const url = `${detailApiBase}${encodeURIComponent(deviceNumId)}${updateSuffix}`;
      const res = await fetch(url, {
        method: 'PATCH',
        headers: {
          'Content-Type':'application/json'
          // 'Authorization': 'Bearer <token>' // si tu API lo requiere
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok){
        const text = await res.text().catch(()=> '');
        throw new Error(`PATCH ${res.status}: ${text || 'error'}`);
      }
      return await res.json().catch(()=> ({}));
    }

    // ============ Detalle dinámico ============
    async function fetchCameraDetail(cam){
      const numId = resolveDeviceId(cam);
      if (!Number.isFinite(numId)) throw new Error('No se pudo resolver un ID numérico para esta cámara');
      const url = `${detailApiBase}${encodeURIComponent(numId)}/`;
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 10000);
      try{
        const res = await fetch(url, { signal: ctrl.signal, cache: 'no-store' });
        clearTimeout(t);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally { clearTimeout(t); }
    }

    // Secciones y mapeo de campos -> etiquetas
    const SECTION_FIELDS = {
      tecnicos: {
        title: 'Información técnica',
        editable: ['ip_cam','modelo','marca','numero_serie','instalacion','energia'],
        labels: {
          ip_cam:'IP Cámara', modelo:'Modelo', marca:'Marca', numero_serie:'N° Serie',
          instalacion:'Instalación', energia:'Energía'
        }
      },
      red: {
        title: 'Red y conectividad',
        editable: ['operador','titular_linea','linea','red','ip_red','usuario_modem','clave_modem','clave_wifi'],
        labels: {
          operador:'Operador', titular_linea:'Titular línea', linea:'Línea',
          red:'Red (SSID)', ip_red:'IP Red', usuario_modem:'Usuario módem',
          clave_modem:'Clave módem', clave_wifi:'Clave WiFi'
        }
      },
      enlaces: {
        title: 'Enlaces',
        editable: ['rtmp'],
        labels: { rtmp:'Stream RTMP' }
      },
      ubicacion: {
        title: 'Ubicación',
        editable: ['ubicacion','latitud','longitud'],
        labels: { ubicacion:'Ubicación (texto)', latitud:'Latitud', longitud:'Longitud' }
      },
      contacto: {
        title: 'Contacto',
        editable: ['host','contacto_host','tecnico','contacto_tecnico'],
        labels: { host:'Host', contacto_host:'Contacto Host', tecnico:'Técnico', contacto_tecnico:'Contacto Técnico' }
      }
      // 'meta' queda solo lectura
    };

    function r(rec, k, fallback='—'){ return (rec && rec[k]!=null && String(rec[k]).trim()!=='') ? String(rec[k]) : fallback; }

    function buildReadOnlyBodies(cam, rec){
      const hls = Array.isArray(cam.streams) ? cam.streams.find(s => s.format === 'hls') : null;
      const streamPrimary = r(rec,'rtmp','') || (hls?.url || '—');

      const ipCam = r(rec,'ip_cam', null);
      const ipRed = r(rec,'ip_red', null);
      const panelUrl = ipCam ? `http://${ipCam}` : (ipRed ? `http://${ipRed}` : '#');

      const latStr = r(rec,'latitud','—');
      const lonStr = r(rec,'longitud','—');
      const latNum = Number(latStr), lonNum = Number(lonStr);
      const hasCoords = Number.isFinite(latNum) && Number.isFinite(lonNum);

      const meta=el('div',{class:'kv'},
        el('div',{class:'muted',text:'Estado'}),el('div',{text:(cam.status||'').toUpperCase()}),
        el('div',{class:'muted',text:'Ubicación'}),el('div',{text: cam.site || cam.location || cam.ciudad || r(rec,'ubicacion','—')}),
        el('div',{class:'muted',text:'País'}),el('div',{text:String(cam.pais??cam.country??'—')}),
        el('div',{class:'muted',text:'ID'}),el('div',{text:getCamId(cam)})
      );

      const tecnicos=el('div',{class:'kv'},
        el('div',{class:'muted',text:'IP Cámara'}),el('div',{text:r(rec,'ip_cam')}),
        el('div',{class:'muted',text:'Modelo'}),el('div',{text:r(rec,'modelo')}),
        el('div',{class:'muted',text:'Marca'}),el('div',{text:r(rec,'marca')}),
        el('div',{class:'muted',text:'N° Serie'}),el('div',{text:r(rec,'numero_serie')}),
        el('div',{class:'muted',text:'Instalación'}),el('div',{text:r(rec,'instalacion')}),
        el('div',{class:'muted',text:'Energía'}),el('div',{text:r(rec,'energia')})
      );

      const red=el('div',{class:'kv'},
        el('div',{class:'muted',text:'Operador'}),el('div',{text:r(rec,'operador')}),
        el('div',{class:'muted',text:'Titular línea'}),el('div',{text:r(rec,'titular_linea')}),
        el('div',{class:'muted',text:'Línea'}),el('div',{text:r(rec,'linea')}),
        el('div',{class:'muted',text:'Red (SSID)'}),el('div',{text:r(rec,'red')}),
        el('div',{class:'muted',text:'IP Red'}),el('div',{text:r(rec,'ip_red')}),
        el('div',{class:'muted',text:'Usuario módem'}),el('div',{text:r(rec,'usuario_modem')}),
        el('div',{class:'muted',text:'Clave módem'}),el('div',{text:r(rec,'clave_modem')}),
        el('div',{class:'muted',text:'Clave WiFi'}),el('div',{text:r(rec,'clave_wifi')})
      );

      const enlaces=el('div',{class:'kv'},
        el('div',{class:'muted',text:'Stream (RTSP/RTMP/HLS)'}),
        el('div',{},
          streamPrimary && streamPrimary !== '—'
            ? el('a',{href:streamPrimary,target:'_blank',rel:'noopener',class:'link'},streamPrimary)
            : el('span',{text:'—'})
        ),
        el('div',{class:'muted',text:'Panel'}),
        el('div',{},
          panelUrl && panelUrl !== '#'
            ? el('a',{href:panelUrl,target:'_blank',rel:'noopener',class:'link'},panelUrl)
            : el('span',{text:'—'})
        )
      );

      const ubicacion=el('div',{class:'kv'},
        el('div',{class:'muted',text:'Latitud'}),el('div',{text:latStr}),
        el('div',{class:'muted',text:'Longitud'}),el('div',{text:lonStr}),
        el('div',{class:'muted',text:'Ver en mapa'}),
        el('div',{},
          hasCoords
            ? el('button',{class:'btn',onClick:()=>window.open(`https://www.google.com/maps?q=${encodeURIComponent(latNum)},${encodeURIComponent(lonNum)}`,'_blank','noopener')},'🌍 Abrir en Google Maps')
            : el('span',{text:'No disponible'})
        )
      );

      const contacto=el('div',{class:'kv'},
        el('div',{class:'muted',text:'Host'}),el('div',{text:r(rec,'host')}),
        el('div',{class:'muted',text:'Contacto Host'}),el('div',{text:r(rec,'contacto_host')}),
        el('div',{class:'muted',text:'Técnico'}),el('div',{text:r(rec,'tecnico')}),
        el('div',{class:'muted',text:'Contacto Técnico'}),el('div',{text:r(rec,'contacto_tecnico')})
      );

      return { meta, tecnicos, red, enlaces, ubicacion, contacto };
    }

    function renderDetail(cam, rec){
      currentDetailRecord = rec; // guarda para comparaciones
      const detail=document.getElementById('detailView');
      document.getElementById('countries').classList.add('hidden');
      detail.classList.remove('hidden');
      detail.innerHTML='';

      const name = cam.name || r(rec,'nombre','Cámara');

      const actions = el('div',{class:'detail-actions'},
        el('button',{class:'btn',onClick:()=>{location.hash='#/';}},'← Volver'),
        el('h2',{text: name})
      );

      const bodies = buildReadOnlyBodies(cam, rec);
      const grid = el('div',{class:'detail-grid'});
      grid.appendChild(sectionCard('Resumen', 'meta', bodies.meta, false));
      grid.appendChild(sectionCard('Información técnica', 'tecnicos', bodies.tecnicos, true));
      grid.appendChild(sectionCard('Red y conectividad', 'red', bodies.red, true));
      grid.appendChild(sectionCard('Enlaces', 'enlaces', bodies.enlaces, true));
      grid.appendChild(sectionCard('Ubicación', 'ubicacion', bodies.ubicacion, true));
      grid.appendChild(sectionCard('Contacto', 'contacto', bodies.contacto, true));

      detail.appendChild(actions);
      detail.appendChild(grid);
    }

    // ======== Modo edición por card ========
    function enterEditSection(sectionKey){
      const def = SECTION_FIELDS[sectionKey];
      if (!def) return;

      const section = document.querySelector(`.section-card[data-section="${sectionKey}"]`);
      if (!section) return;
      const body = section.querySelector('.card-body');
      body.innerHTML = '';

      const form = el('div',{class:'kv'});
      def.editable.forEach(k=>{
        const fieldWrap = el('div',{class:'field'});
        const label = el('label',{text:def.labels[k] || k});
        const input = el('input',{class:'input', name:k, value: r(currentDetailRecord,k,'')});
        // Validaciones simples
        if (sectionKey==='ubicacion' && (k==='latitud' || k==='longitud')) input.type='number', input.step='any';
        if (k.includes('clave')) input.type='text'; // podrías usar 'password' si prefieres
        fieldWrap.appendChild(label);
        fieldWrap.appendChild(input);
        form.appendChild(fieldWrap);
      });

      const errBox = el('p',{class:'error',style:'display:none'});
      const actions = el('div',{class:'card-actions'},
        el('button',{class:'btn',onClick:()=>exitEditSection(sectionKey)},'Cancelar'),
        el('button',{class:'btn primary',onClick:()=>saveSection(sectionKey,form,errBox)},'Guardar')
      );
      const hint = el('div',{class:'hint',text:'Solo se guardarán los campos modificados.'});

      body.appendChild(form);
      body.appendChild(actions);
      body.appendChild(errBox);
      body.appendChild(hint);
    }

    function exitEditSection(sectionKey){
      // Re-renderear solo esa sección con los datos actuales
      const section = document.querySelector(`.section-card[data-section="${sectionKey}"] .card-body`);
      if (!section) return;
      const cam = getCurrentCamFromHash();
      if (!cam) return;
      const bodies = buildReadOnlyBodies(cam, currentDetailRecord);
      const node = bodies[sectionKey];
      section.innerHTML='';
      section.appendChild(node);
    }

    function diffPayload(sectionKey, formEl){
      const payload = {};
      const def = SECTION_FIELDS[sectionKey];
      def.editable.forEach(k=>{
        const input = formEl.querySelector(`[name="${k}"]`);
        if (!input) return;
        const original = r(currentDetailRecord,k,'');
        const val = String(input.value ?? '');
        if (val !== String(original)) payload[k] = val;
      });
      return payload;
    }

    async function saveSection(sectionKey, formEl, errBox){
      try{
        const cam = getCurrentCamFromHash();
        if (!cam) throw new Error('No se encontró la cámara actual');
        const deviceNumId = resolveDeviceId(cam);
        if (!Number.isFinite(deviceNumId)) throw new Error('ID de dispositivo inválido');

        // Validaciones simples para ubicación
        if (sectionKey==='ubicacion'){
          const lat = formEl.querySelector('[name="latitud"]')?.value?.trim();
          const lon = formEl.querySelector('[name="longitud"]')?.value?.trim();
          if (lat && isNaN(Number(lat))) throw new Error('Latitud debe ser numérica');
          if (lon && isNaN(Number(lon))) throw new Error('Longitud debe ser numérica');
        }

        const payload = diffPayload(sectionKey, formEl);
        if (Object.keys(payload).length===0){
          exitEditSection(sectionKey);
          return;
        }

        // UI: deshabilitar botones
        const btns = formEl.parentElement.querySelectorAll('button');
        btns.forEach(b=>b.disabled=true);

        const res = await apiPatch(deviceNumId, payload);

        // Merge al record actual
        Object.assign(currentDetailRecord, payload);

        // Rerender solo esa sección
        exitEditSection(sectionKey);
      }catch(e){
        console.error(e);
        errBox.textContent = e.message || 'Error al guardar';
        errBox.style.display='block';
      }finally{
        // re-habilitar
        const btns = formEl.parentElement?.querySelectorAll?.('button');
        btns && btns.forEach(b=>b.disabled=false);
      }
    }

    function getCurrentCamFromHash(){
      const h=location.hash||'#/';
      const m=h.match(/^#\/camera\/([^#?]+)/);
      if(!m) return null;
      const id=decodeURIComponent(m[1]);
      return camIndex.get(id) || null;
    }

    async function showDetail(cam){
      const detail=document.getElementById('detailView');
      document.getElementById('countries').classList.add('hidden');
      detail.classList.remove('hidden');

      // Skeletons
      renderDetailSkeleton(cam);

      try{
        const rec = await fetchCameraDetail(cam);
        renderDetail(cam, rec);
      }catch(err){
        console.error('Error cargando detalle:', err);

        // Fallback básico
        detail.innerHTML='';
        const actions = el('div',{class:'detail-actions'},
          el('button',{class:'btn',onClick:()=>{location.hash='#/';}},'← Volver'),
          el('h2',{text:cam.name || 'Cámara'})
        );

        const grid = el('div',{class:'detail-grid'});
        const meta=el('div',{class:'kv'},
          el('div',{class:'muted',text:'Estado'}),el('div',{text:(cam.status||'').toUpperCase()}),
          el('div',{class:'muted',text:'Ubicación'}),el('div',{text: cam.site || cam.location || cam.ciudad || '—'}),
          el('div',{class:'muted',text:'País'}),el('div',{text:String(cam.pais??cam.country??'—')}),
          el('div',{class:'muted',text:'ID'}),el('div',{text:getCamId(cam)})
        );

        const latStr = cam.latitud, lonStr = cam.longitud;
        const latNum = Number(latStr), lonNum = Number(lonStr);
        const hasCoords = Number.isFinite(latNum) && Number.isFinite(lonNum);
        const ubicFallback = el('div',{class:'kv'},
          el('div',{class:'muted',text:'Latitud'}), el('div',{text: latStr ?? '—'}),
          el('div',{class:'muted',text:'Longitud'}), el('div',{text: lonStr ?? '—'}),
          el('div',{class:'muted',text:'Ver en mapa'}),
          el('div',{}, hasCoords
            ? el('button',{class:'btn',onClick:()=>window.open(`https://www.google.com/maps?q=${encodeURIComponent(latNum)},${encodeURIComponent(lonNum)}`,'_blank','noopener')},'🌍 Abrir en Google Maps')
            : el('span',{text:'No disponible'})
          )
        );

        const warn = el('p',{class:'error',text:'No se pudo cargar el detalle de la cámara. Edición no disponible.'});

        grid.appendChild(sectionCard('Resumen','meta', meta, false));
        grid.appendChild(sectionCard('Ubicación','ubicacion', ubicFallback, false));
        grid.appendChild(sectionCard('Aviso','aviso', warn, false));

        detail.appendChild(actions);
        detail.appendChild(grid);
      }
    }

    function router(){
      const h=location.hash||'#/';
      const m=h.match(/^#\/camera\/([^#?]+)/);
      if(m){ const id=decodeURIComponent(m[1]); const cam=camIndex.get(id); if(cam){showDetail(cam);} else {showList();} }
      else{showList();}
    }

    window.addEventListener('hashchange',router);

    // ============ Carga y render principal ============
    async function load(manual=false){
      const subtitle=document.getElementById('subtitle');
      const container=document.getElementById('countries');
      const errorBox=document.getElementById('errorBox');
      const refreshBtn=document.getElementById('refreshBtn');

      errorBox.style.display='none';
      const prevText = subtitle.textContent;
      if(manual){ subtitle.textContent='Actualizando…'; }
      if(refreshBtn){ refreshBtn.disabled = true; refreshBtn.textContent = 'Actualizando…'; }

      try{
        const ctrl=new AbortController();
        const t=setTimeout(()=>ctrl.abort(),10000);
        const res=await fetch(listApiUrl,{signal:ctrl.signal});
        clearTimeout(t);
        if(!res.ok)throw new Error(`HTTP ${res.status}`);
        const data=await res.json();

        currentData=Array.isArray(data)?data:[];
        indexCameras(currentData);
        subtitle.textContent=`Actualizado: ${new Date().toLocaleString('es-PE')}`;

        const byCountry=new Map(countries.map(c=>[c.id,[]]));
        for(const cam of currentData){
          const pid=String(cam.pais??cam.country_id??cam.country??'');
          if(byCountry.has(pid))byCountry.get(pid).push(cam);
        }

        // Destruir charts antes de rehacer DOM
        charts.forEach(ch => { try { ch.destroy(); } catch(_){} });
        charts.clear();

        // Re-render
        container.innerHTML='';
        countries.forEach(country=>{
          const cams=byCountry.get(country.id)||[];
          const card=renderCountryCard(country,cams);
          container.appendChild(card);
          const {online,offline}=byStatus(cams);
          upsertChart(country.id,online.length,offline.length);
        });

        router();
      }catch(err){
        console.error('Error cargando las cámaras:',err);
        errorBox.textContent='No se pudo cargar la información. Intenta nuevamente.';
        errorBox.style.display='block';
        if(manual){ subtitle.textContent = prevText; }
      }finally{
        if(refreshBtn){ refreshBtn.disabled = false; refreshBtn.textContent = '↻ Actualizar'; }
      }
    }

    // Carga inicial
    load();

    // Botón para actualizar bajo demanda
    document.getElementById('refreshBtn').addEventListener('click', ()=> load(true));
  </script>
</body>
</html>
